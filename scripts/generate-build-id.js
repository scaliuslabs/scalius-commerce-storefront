#!/usr/bin/env node
/**
 * Generate Build ID for Cache Invalidation
 *
 * This script generates a unique BUILD_ID on every build.
 * The middleware uses this to detect deployments and auto-purge cache.
 *
 * How it works:
 * 1. Build script runs this BEFORE astro build
 * 2. Generates timestamp-based BUILD_ID
 * 3. Writes to src/config/build-id.ts
 * 4. Gets included in deployment
 * 5. Middleware compares with KV stored BUILD_ID
 * 6. If different → auto-purge cache
 */

import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { mkdirSync, writeFileSync, existsSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const BUILD_ID = Date.now().toString();
const configDir = join(__dirname, '../src/config');
const outputFile = join(configDir, 'build-id.ts');

// Ensure config directory exists
if (!existsSync(configDir)) {
  mkdirSync(configDir, { recursive: true });
}

const content = `/**
 * Auto-generated Build ID
 * Generated at build time: ${new Date().toISOString()}
 *
 * DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated by scripts/generate-build-id.js
 */

export const BUILD_ID = "${BUILD_ID}";
`;

writeFileSync(outputFile, content, 'utf-8');

console.log(`✅ Build ID generated: ${BUILD_ID}`);
console.log(`   Written to: ${outputFile}`);
