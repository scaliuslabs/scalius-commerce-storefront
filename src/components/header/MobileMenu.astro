---
import type { NavigationItem, SocialLink } from "@/lib/api";
import { X, ChevronDown, Phone, ChevronRight } from "lucide-react";

interface Props {
  navigation: NavigationItem[];
  contact: { phone: string; text: string };
  social?: SocialLink[];
}

const { navigation = [], contact, social = [] } = Astro.props;

// Helper function to generate unique IDs for nested items
function generateMenuId(item: NavigationItem, prefix: string = ""): string {
  const baseId = item.id || item.title.toLowerCase().replace(/\s+/g, "-");
  return prefix ? `${prefix}-${baseId}` : baseId;
}
---

<div
  id="mobile-menu-overlay"
  class="fixed inset-0 z-60 bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-500 lg:hidden"
  aria-hidden="true"
>
</div>

<div
  id="mobile-menu-panel"
  class="fixed top-0 left-0 z-70 h-dvh w-[90vw] max-w-[380px] bg-white text-gray-900 shadow-2xl transform -translate-x-full transition-transform duration-500 cubic-bezier(0.19, 1, 0.22, 1) lg:hidden flex flex-col border-r border-gray-100"
  role="dialog"
  aria-modal="true"
  aria-label="Mobile Menu"
>
  <div
    class="flex items-center justify-between px-5 py-3 border-b border-gray-100 shrink-0 bg-white shadow-[0_1px_2px_rgba(0,0,0,0.03)] z-10"
  >
    <h2 class="text-base font-bold tracking-tight text-gray-900 uppercase">
      Menu
    </h2>
    <button
      id="mobile-menu-close"
      type="button"
      class="p-2 -mr-2 text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors active:scale-95"
      aria-label="Close menu"
    >
      <X className="h-5 w-5 stroke-[1.5]" />
    </button>
  </div>

  <nav
    class="flex-1 overflow-y-auto overscroll-contain px-5 py-3 scrollbar-hide relative group"
    id="mobile-nav-container"
  >
    <ul class="space-y-1">
      {
        Array.isArray(navigation) &&
          navigation.map((item) => {
            const menuId = generateMenuId(item);
            const hasSubMenu = item.subMenu && item.subMenu.length > 0;
            return (
              <li>
                {hasSubMenu ? (
                  <div class="group/item">
                    <div class="flex items-center justify-between">
                      <a
                        href={item.href || "#"}
                        class="flex-1 text-[16px] font-bold text-gray-900 hover:text-green-700 transition-colors py-2.5"
                      >
                        {item.title}
                      </a>
                      <button
                        type="button"
                        class="flex items-center justify-center w-10 h-10 -mr-2 text-gray-400 hover:text-gray-900 active:bg-gray-50 rounded-full transition-all"
                        data-menu-toggle={menuId}
                        aria-expanded="false"
                        aria-label={`Toggle ${item.title} submenu`}
                      >
                        <ChevronDown className="h-4.5 w-4.5 stroke-2 transition-transform duration-300 pointer-events-none" />
                      </button>
                    </div>

                    <div
                      class="hidden overflow-hidden transition-[height] duration-300 ease-in-out"
                      data-submenu={menuId}
                    >
                      <div class="border-l-2 border-gray-100 ml-2.5 pl-3 mt-1 mb-2 space-y-1">
                        <ul class="space-y-0.5">
                          {(item.subMenu || []).map((level2Item) => {
                            const level2Id = generateMenuId(level2Item, menuId);
                            const hasLevel2Sub =
                              level2Item.subMenu &&
                              level2Item.subMenu.length > 0;
                            return (
                              <li>
                                {hasLevel2Sub ? (
                                  <div>
                                    <div class="flex items-center justify-between group/sub">
                                      <a
                                        href={level2Item.href || "#"}
                                        class="flex-1 text-[14px] font-semibold text-gray-700 hover:text-gray-900 transition-colors py-2"
                                      >
                                        {level2Item.title}
                                      </a>
                                      <button
                                        type="button"
                                        class="flex items-center justify-center w-9 h-9 -mr-1 text-gray-400 hover:text-gray-900 rounded-full transition-colors"
                                        data-menu-toggle={level2Id}
                                        aria-expanded="false"
                                      >
                                        <ChevronDown className="h-4 w-4 stroke-2 transition-transform duration-300 pointer-events-none" />
                                      </button>
                                    </div>

                                    <div class="hidden" data-submenu={level2Id}>
                                      <ul class="space-y-0.5 border-l border-gray-100 ml-2 pl-3 mt-0.5 py-1">
                                        {(level2Item.subMenu || []).map(
                                          (level3Item) => {
                                            const level3Id = generateMenuId(
                                              level3Item,
                                              level2Id
                                            );
                                            return (
                                              <li>
                                                <a
                                                  href={level3Item.href || "#"}
                                                  class="block text-[13px] font-medium text-gray-500 hover:text-gray-900 transition-colors py-1.5"
                                                >
                                                  {level3Item.title}
                                                </a>
                                              </li>
                                            );
                                          }
                                        )}
                                      </ul>
                                    </div>
                                  </div>
                                ) : (
                                  <a
                                    href={level2Item.href || "#"}
                                    class="block text-[14px] font-semibold text-gray-700 hover:text-gray-900 transition-colors py-2"
                                  >
                                    {level2Item.title}
                                  </a>
                                )}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    </div>
                  </div>
                ) : (
                  <a
                    href={item.href || "#"}
                    class="block text-[16px] font-bold text-gray-900 hover:text-green-700 transition-colors py-2.5"
                  >
                    {item.title}
                  </a>
                )}
              </li>
            );
          })
      }
    </ul>

    <div class="h-4"></div>
  </nav>

  <!-- Scroll Hint Shadow (Visible when content overflows) -->
  <div
    class="absolute bottom-[calc(88px+env(safe-area-inset-bottom))] left-0 right-0 h-8 bg-linear-to-t from-white to-transparent pointer-events-none z-10 lg:hidden"
  >
  </div>

  <div class="border-t border-gray-100 bg-gray-50 p-4 space-y-3 shrink-0 z-20">
    {
      contact.phone && (
        <a
          href={`tel:${contact.phone}`}
          class="flex items-center gap-3 p-3 bg-white border border-gray-200/60 rounded-xl shadow-sm active:scale-[0.99] transition-all group hover:border-gray-300"
        >
          <div class="h-9 w-9 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
            <Phone className="h-4.5 w-4.5 fill-current" />
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider leading-none mb-0.5">
              Call Support
            </p>
            <p class="text-sm font-bold text-gray-900 tracking-tight truncate">
              {contact.phone}
            </p>
          </div>
          <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center group-hover:bg-gray-100 transition-colors">
            <ChevronRight className="h-4 w-4 text-gray-400 group-hover:text-gray-600" />
          </div>
        </a>
      )
    }

    {
      social && social.length > 0 && (
        <div class="flex items-center justify-center gap-3">
          {social.map((item) => {
            if (!item.url) return null;
            const displayTitle = item.label || item.platform || "Social";
            const href = item.url.startsWith("http")
              ? item.url
              : `https://${item.url}`;

            return (
              <a
                href={href}
                class="flex items-center justify-center h-9 w-9 rounded-full bg-white border border-gray-200 text-gray-400 hover:border-gray-300 hover:text-gray-900 hover:shadow-sm transition-all"
                target="_blank"
                rel="noopener noreferrer"
                title={displayTitle}
              >
                {item.iconUrl ? (
                  <img
                    src={item.iconUrl}
                    alt={displayTitle}
                    class="w-4 h-4 object-contain"
                    loading="lazy"
                  />
                ) : (
                  <span class="text-[10px] font-bold uppercase">
                    {displayTitle.charAt(0)}
                  </span>
                )}
                <span class="sr-only">{displayTitle}</span>
              </a>
            );
          })}
        </div>
      )
    }
  </div>
</div>
