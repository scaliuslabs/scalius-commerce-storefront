---
// src/components/product/ProductGallery.astro
import { getImage } from "astro:assets";
import type { Product, ProductImage } from "@/lib/api";
import { GALLERY_CONFIG } from "./config";
import ProductImageZoom from "./ProductImageZoom";
import { Maximize2, X, ChevronDown, ChevronUp } from "lucide-react";

interface Props {
  product: Product;
  images: ProductImage[];
}

const { product, images } = Astro.props;
const desktopThumb = GALLERY_CONFIG.thumbnails.desktop;
const mobileThumb = GALLERY_CONFIG.thumbnails.mobile;
const hasMultipleImages = images.length > 1;

const optimizedImages = await Promise.all(
  images.map(async (img) => {
    const thumb = await getImage({
      src: img.url,
      width: desktopThumb.imageSize,
      height: desktopThumb.imageSize,
      format: "avif",
      quality: 80,
    });

    const main = await getImage({
      src: img.url,
      width: 800,
      height: 800,
      format: "avif",
      quality: 85,
    });

    const zoom = await getImage({
      src: img.url,
      width: 1400,
      height: 1400,
      format: "avif",
      quality: 90,
    });

    return {
      original: img,
      thumbUrl: thumb.src,
      mainUrl: main.src,
      zoomUrl: zoom.src,
    };
  })
);
---

<div id="product-gallery" class="lg:col-span-7 xl:col-span-6 relative w-full group/gallery">
  <div
    class:list={[
      "flex flex-col gap-3 lg:gap-5 lg:sticky",
      hasMultipleImages ? "lg:grid lg:grid-cols-[80px_1fr] xl:grid-cols-[100px_1fr]" : "lg:block"
    ]}
    style="top: 5rem;"
  >
    {
      hasMultipleImages && (
        <div class="hidden lg:block relative h-full w-full">
          <div
            id="thumb-scroll-top"
            class="absolute -top-1 left-0 right-0 h-8 z-10 opacity-0 pointer-events-none transition-opacity duration-300 flex items-start justify-center cursor-pointer select-none"
            role="button"
            aria-label="Scroll up"
          >
             <div class="p-0.5 bg-white rounded-full text-gray-500 shadow-xs border border-gray-100 hover:text-black hover:scale-110 transition-transform duration-200 animate-bounce">
              <ChevronUp className="w-4 h-4" />
            </div>
          </div>

          <div
            id="desktop-thumbnails"
            class="absolute inset-0 flex flex-col gap-3 overflow-y-auto pr-1 pb-4 scroll-smooth custom-scrollbar snap-y snap-mandatory"
          >
            {optimizedImages.map((imgData, index) => (
              <button
                class="thumbnail-btn snap-start group relative w-full aspect-square rounded-lg overflow-hidden border border-transparent transition-all duration-300 focus:outline-none bg-gray-50 shrink-0 hover:ring-2 hover:ring-gray-200"
                data-image-url={imgData.mainUrl}
                data-zoom-url={imgData.zoomUrl}
                data-index={index}
                aria-label={`View image ${index + 1}`}
              >
                <img
                  src={imgData.thumbUrl}
                  alt={imgData.original.alt || `${product.name} thumbnail ${index + 1}`}
                  width={desktopThumb.imageSize}
                  height={desktopThumb.imageSize}
                  class="h-full w-full object-cover object-center transition-transform duration-500 group-hover:scale-110"
                  loading={index < 5 ? "eager" : "lazy"}
                />
                <div class="thumb-ring absolute inset-0 border-2 border-transparent rounded-lg pointer-events-none transition-colors duration-200" />
              </button>
            ))}
          </div>

          <div
            id="thumb-scroll-bottom"
            class="absolute bottom-0 left-0 right-0 h-12 z-10 flex items-end justify-center pb-1 transition-opacity duration-300 opacity-0 pointer-events-none cursor-pointer select-none"
            role="button"
            aria-label="Scroll down"
          >
            <div class="p-0.5 bg-white rounded-full text-gray-500 shadow-xs border border-gray-100 hover:text-black hover:scale-110 transition-transform duration-200 animate-bounce">
              <ChevronDown className="w-4 h-4" />
            </div>
          </div>
        </div>
      )
    }

    <div class="flex-1 relative z-10 min-w-0">
      <div class="flex items-stretch gap-2">
        <div class="flex-1 relative group/main">
          <div
            class="hidden lg:block relative w-full aspect-square bg-gray-50 rounded-xl overflow-hidden cursor-zoom-in"
          >
            <ProductImageZoom
              client:media="(min-width: 1024px)"
              initialImage={optimizedImages[0]?.mainUrl || "/img/no-image.webp"}
              initialZoomImage={optimizedImages[0]?.zoomUrl}
              alt={product.name}
              aspectRatio="aspect-square"
            />
          </div>

          <div
            class="lg:hidden relative w-full aspect-square bg-gray-50 rounded-xl overflow-hidden cursor-zoom-in active:scale-[0.99] transition-transform duration-200"
            id="mobile-image-trigger"
          >
            <img
              id="mobile-main-image"
              src={optimizedImages[0]?.mainUrl || "/img/no-image.webp"}
              alt={product.name}
              width="600"
              height="600"
              class="h-full w-full object-contain object-center"
              loading="eager"
            />
            <div
              class="absolute bottom-3 right-3 bg-black/40 text-white p-2 text-xs font-medium rounded-full backdrop-blur-md opacity-0 group-hover/main:opacity-100 transition-opacity duration-300 pointer-events-none flex items-center gap-1"
            >
              <Maximize2 className="h-3 w-3" />
              <span>Zoom</span>
            </div>
          </div>
        </div>

        {
          hasMultipleImages && (
            <div class="lg:hidden w-[18vw] max-w-[80px] shrink-0 relative">
                <div
                id="mobile-thumb-scroll-top"
                class="absolute -top-1 left-0 right-0 h-8 z-10 opacity-0 pointer-events-none transition-opacity duration-300 flex items-start justify-center cursor-pointer select-none"
                role="button"
                aria-label="Scroll up"
              >
                 <div class="p-0.5 bg-white rounded-full text-gray-500 shadow-xs border border-gray-100 hover:text-black hover:scale-110 transition-transform duration-200 animate-bounce">
                  <ChevronUp className="w-3 h-3" />
                </div>
              </div>

              <div id="mobile-thumbnails" class="absolute inset-0 overflow-y-auto scrollbar-hide pb-2 touch-pan-y snap-y snap-mandatory">
                <div class="flex flex-col gap-2.5 pt-1">
                  {optimizedImages.map((imgData, index) => (
                    <button
                      class="thumbnail-btn snap-start group relative w-full aspect-square rounded-lg overflow-hidden border border-gray-100 bg-white transition-all duration-200 active:scale-95"
                      data-image-url={imgData.mainUrl}
                      data-zoom-url={imgData.zoomUrl}
                      data-index={index}
                    >
                      <img
                        src={imgData.thumbUrl}
                        alt={imgData.original.alt || `${product.name} thumbnail`}
                        width={mobileThumb.imageSize}
                        height={mobileThumb.imageSize}
                        class="h-full w-full object-cover object-center"
                        loading="lazy"
                      />
                      <div class="thumb-ring absolute inset-0 border-2 border-transparent rounded-lg pointer-events-none" />
                    </button>
                  ))}
                </div>
              </div>

               <div
                id="mobile-thumb-scroll-bottom"
                class="absolute bottom-0 left-0 right-0 h-10 z-10 flex items-end justify-center pb-1 transition-opacity duration-300 opacity-0 pointer-events-none cursor-pointer select-none"
                role="button"
                aria-label="Scroll down"
              >
                <div class="p-0.5 bg-white rounded-full text-gray-500 shadow-xs border border-gray-100 hover:text-black hover:scale-110 transition-transform duration-200 animate-bounce">
                  <ChevronDown className="w-3 h-3" />
                </div>
              </div>
            </div>
          )
        }
      </div>
    </div>
  </div>
</div>

<!-- FULLSCREEN MOBILE ZOOM MODAL -->
<div
  id="mobile-zoom-modal"
  class="fixed inset-0 z-100 bg-black/98 backdrop-blur-2xl transition-all duration-300 opacity-0 pointer-events-none flex flex-col touch-none"
  aria-hidden="true"
>
  <!-- Toolbar -->
  <div class="absolute top-0 left-0 right-0 p-4 flex justify-end z-20">
    <button
      id="close-zoom"
      class="p-2.5 bg-white/10 rounded-full text-white active:bg-white/20 transition-colors backdrop-blur-md"
      tabindex="-1"
    >
      <X className="h-6 w-6" />
    </button>
  </div>

  <!-- Zoomable Container -->
  <div
    class="flex-1 relative overflow-hidden flex items-center justify-center w-full h-full"
    id="panzoom-container"
  >
    <img
      id="fullscreen-image"
      src=""
      alt="Zoom view"
      class="max-w-full max-h-full object-contain transition-transform duration-100 ease-out origin-center will-change-transform"
    />
  </div>

  <div
    class="absolute bottom-8 left-0 right-0 text-center text-white/50 text-xs pointer-events-none"
  >
    Double tap to zoom â€¢ Drag to pan
  </div>
</div>

<style>
  /* CSS Containment for Performance */
  #product-gallery {
    contain: layout style;
  }
  .thumbnail-btn {
    contain: layout style paint;
  }
  .thumbnail-btn img {
    contain: strict;
  }

  /* Custom Thin Scrollbar for Desktop Thumbnails */
  .custom-scrollbar::-webkit-scrollbar {
    width: 3px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
    border-radius: 20px;
  }
  .custom-scrollbar:hover::-webkit-scrollbar-thumb {
    background-color: #94a3b8;
  }
  
  /* Active State Override */
  .thumbnail-btn .thumb-ring.\!border-black {
    border-color: #000 !important;
  }
</style>

<script>
  const imageCache = new Map<string, HTMLImageElement>();
  
  function preloadImage(url: string): Promise<void> {
    if (!url || imageCache.has(url)) return Promise.resolve();
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => { imageCache.set(url, img); resolve(); };
      img.onerror = () => resolve();
      img.src = url;
    });
  }

  function preloadAllGalleryImages() {
    const thumbs = document.querySelectorAll<HTMLElement>('.thumbnail-btn');
    const mainUrls: string[] = [];
    const zoomUrls: string[] = [];
    
    thumbs.forEach((btn, i) => {
      const mainUrl = btn.dataset.imageUrl;
      const zoomUrl = btn.dataset.zoomUrl;
      if (mainUrl) mainUrls.push(mainUrl);
      if (zoomUrl) zoomUrls.push(zoomUrl);
    });
    
    mainUrls.forEach(url => preloadImage(url));
    
    const connection = (navigator as any).connection;
    const isFastConnection = !connection || connection.effectiveType === '4g';
    if (isFastConnection) {
      setTimeout(() => {
        zoomUrls.forEach(url => preloadImage(url));
      }, 1000);
    }
  }

  function initGallery() {
    const gallery = document.getElementById("product-gallery");
    if(!gallery) return;

    const thumbs = gallery.querySelectorAll<HTMLElement>(".thumbnail-btn");
    let hoverTimeout: number | null = null;
    let lastSwitchedUrl = '';

    if (thumbs.length > 0) {
      updateActiveRing(thumbs[0] as HTMLElement);
      
      if ('requestIdleCallback' in window) {
        (window as any).requestIdleCallback(preloadAllGalleryImages, { timeout: 2000 });
      } else {
        setTimeout(preloadAllGalleryImages, 500);
      }

      gallery.addEventListener("click", (e) => {
        const btn = (e.target as HTMLElement).closest(".thumbnail-btn") as HTMLElement;
        if (!btn || !gallery.contains(btn)) return;
        handleThumbClick(btn);
      });
      
      if (window.matchMedia("(hover: hover)").matches) {
        thumbs.forEach(btn => {
          btn.addEventListener("mouseenter", () => {
            if (hoverTimeout) clearTimeout(hoverTimeout);
            hoverTimeout = window.setTimeout(() => {
              handleThumbClick(btn as HTMLElement);
            }, 50);
          });
          btn.addEventListener("mouseleave", () => {
            if (hoverTimeout) {
              clearTimeout(hoverTimeout);
              hoverTimeout = null;
            }
          });
        });
      }
    }

    function handleThumbClick(target: HTMLElement) {
       const url = target.dataset.imageUrl;
       const zoomUrl = target.dataset.zoomUrl || url; 
       
       if (!url || url === lastSwitchedUrl) return;
       lastSwitchedUrl = url;

       updateActiveRing(target);

       window.dispatchEvent(
         new CustomEvent("product-image-change", {
           detail: { url, zoomUrl },
         })
       );

       const mobileImg = document.getElementById(
         "mobile-main-image"
       ) as HTMLImageElement;
       if (mobileImg) {
          mobileImg.style.opacity = '0.5';
          mobileImg.src = url;
          mobileImg.onload = () => { mobileImg.style.opacity = '1'; };
       }

       const fsImg = document.getElementById(
         "fullscreen-image"
       ) as HTMLImageElement;
       if (fsImg) fsImg.src = zoomUrl || url;
    }

    window.addEventListener("controller-image-update", ((e: CustomEvent) => {
      const url = e.detail?.url;
      if (!url) return;

      const mobileImg = document.getElementById("mobile-main-image") as HTMLImageElement;
      if (mobileImg) mobileImg.src = url;

      const fsImg = document.getElementById("fullscreen-image") as HTMLImageElement;
      if (fsImg) fsImg.src = url;

      const galleryEl = document.getElementById("product-gallery");
      if (!galleryEl) return;
      
      const matchingThumb = galleryEl.querySelector<HTMLElement>(
        `.thumbnail-btn[data-image-url="${url}"]`
      );
      if (matchingThumb) {
        updateActiveRing(matchingThumb);
        matchingThumb.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    }) as EventListener);
  }

  function updateActiveRing(activeBtn: HTMLElement) {
    document
      .querySelectorAll(".thumb-ring")
      .forEach((ring) => ring.classList.remove("!border-black"));
    const ring = activeBtn.querySelector(".thumb-ring");
    if (ring) ring.classList.add("!border-black");
    
    document.querySelectorAll(".thumbnail-btn").forEach(btn => btn.classList.remove("ring-2", "ring-black/5"));
  }

  function setupScrollIndicators(containerId: string, topBtnId: string, bottomBtnId: string) {
    const container = document.getElementById(containerId);
    const topIndicator = document.getElementById(topBtnId);
    const bottomIndicator = document.getElementById(bottomBtnId);

    if (!container || !topIndicator || !bottomIndicator) return;

    topIndicator.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      container.scrollBy({ top: -150, behavior: "smooth" });
    });

    bottomIndicator.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      container.scrollBy({ top: 150, behavior: "smooth" });
    });

    const checkScroll = () => {
      const { scrollTop, scrollHeight, clientHeight } = container;
      const isScrollable = scrollHeight > clientHeight;

      if (scrollTop > 10) {
        topIndicator.classList.remove("opacity-0", "pointer-events-none");
      } else {
        topIndicator.classList.add("opacity-0", "pointer-events-none");
      }

      if (isScrollable && Math.round(scrollTop + clientHeight) < scrollHeight - 10) {
        bottomIndicator.classList.remove("opacity-0", "pointer-events-none");
      } else {
        bottomIndicator.classList.add("opacity-0", "pointer-events-none");
      }
    };

    container.addEventListener("scroll", checkScroll);
    setTimeout(checkScroll, 100);
    window.addEventListener("resize", checkScroll);
  }

  function initScrollIndicators() {
    setupScrollIndicators("desktop-thumbnails", "thumb-scroll-top", "thumb-scroll-bottom");
    setupScrollIndicators("mobile-thumbnails", "mobile-thumb-scroll-top", "mobile-thumb-scroll-bottom");
  }

  function initMobileZoom() {
    const trigger = document.getElementById("mobile-image-trigger");
    const modal = document.getElementById("mobile-zoom-modal");
    const closeBtn = document.getElementById("close-zoom");
    const img = document.getElementById("fullscreen-image") as HTMLImageElement;
    const container = document.getElementById("panzoom-container");

    if (!trigger || !modal || !closeBtn || !img || !container) return;

    let scale = 1;
    let pointX = 0;
    let pointY = 0;
    let startX = 0;
    let startY = 0;
    let isDragging = false;

    const setTransform = () => {
      img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
    };

    const openModal = () => {
      const activeThumb = document.querySelector(".thumbnail-btn .thumb-ring.\\!border-black")?.closest(".thumbnail-btn") as HTMLElement;
      let srcToUse = activeThumb?.dataset.zoomUrl || (document.getElementById("mobile-main-image") as HTMLImageElement)?.src || "";
      
      if (srcToUse) img.src = srcToUse;

      modal.classList.remove("pointer-events-none", "opacity-0");
      document.body.style.overflow = "hidden";
      scale = 1; pointX = 0; pointY = 0; setTransform();
    };

    const closeModal = () => {
      modal.classList.add("opacity-0", "pointer-events-none");
      document.body.style.overflow = "";
    };

    trigger.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    let initialPinchDistance = 0;
    let initialScale = 1;

    container.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          initialPinchDistance = Math.hypot(dx, dy);
          initialScale = scale;
        } else if (e.touches.length === 1 && scale > 1) {
          isDragging = true;
          startX = e.touches[0].clientX - pointX;
          startY = e.touches[0].clientY - pointY;
        }
    }, { passive: false });

    container.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.hypot(dx, dy);
          scale = Math.min(Math.max(1, initialScale * (distance / initialPinchDistance)), 4);
          setTransform();
        } else if (e.touches.length === 1 && isDragging) {
          e.preventDefault();
          pointX = e.touches[0].clientX - startX;
          pointY = e.touches[0].clientY - startY;
          setTransform();
        }
    }, { passive: false });

    container.addEventListener("touchend", () => {
      isDragging = false;
      if (scale < 1.1) {
        scale = 1; pointX = 0; pointY = 0; setTransform();
      }
    });
    
    let lastTap = 0;
    container.addEventListener("click", () => {
       const now = Date.now();
       if (now - lastTap < 300) {
           if(scale > 1) { scale = 1; pointX = 0; pointY = 0; }
           else { scale = 2.5; pointX = 0; pointY = 0; }
           setTransform();
       }
       lastTap = now;
    });
  }

  document.addEventListener("astro:page-load", () => {
    initGallery(); initScrollIndicators(); initMobileZoom();
  });
  document.addEventListener("DOMContentLoaded", () => {
    initGallery(); initScrollIndicators(); initMobileZoom();
  });
</script>
