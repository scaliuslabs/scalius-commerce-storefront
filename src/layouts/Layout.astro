---
// src/layouts/Layout.astro
import "../styles/global.css";
import Header from "../components/header/header.astro";
import Footer from "../components/Footer.astro";
import { Toaster } from "@/components/ui/sonner";
import { getLayoutData, type LayoutData } from "@/lib/api";
import type { AnalyticsConfig } from "@/lib/api";
import CommandPalette from "@/components/search/CommandPalette";
import AuthModal from "@/components/AuthModal";

interface Props {
  title: string;
  description?: string;
  hideHeader?: boolean;
  hideFooter?: boolean;
  /** Pre-fetched layout data for parallel loading optimization */
  layoutData?: LayoutData | null;
}

const {
  title,
  description = "",
  hideHeader = false,
  hideFooter = false,
  layoutData: providedLayoutData,
} = Astro.props;

// Use provided layout data if available (parallel fetch), otherwise fetch here (backward compat)
const layoutData = providedLayoutData ?? await getLayoutData();

const analyticsScripts: AnalyticsConfig[] = layoutData?.analytics || [];
const navigationData = layoutData?.navigation || [];

// Provide sensible defaults if API fails to prevent blank header/footer
const headerData = layoutData?.header ?? {
  topBar: { text: "", isEnabled: false },
  logo: { src: "", alt: "Store" },
  favicon: { src: "/favicon.svg", alt: "" },
  contact: { phone: "", text: "", isEnabled: false },
  social: [],
};

const footerData = layoutData?.footer ?? {
  logo: { src: "", alt: "Store" },
  favicon: { src: "/favicon.svg", alt: "" },
  tagline: "",
  description: "",
  copyrightText: "Your Store",
  menus: [],
  social: [],
};

const faviconUrl = headerData?.favicon?.src || "/favicon.svg";

const currencySymbol = layoutData?.currency?.symbol ?? "à§³";
const currencyCode = layoutData?.currency?.code ?? "BDT";

const headScripts = analyticsScripts.filter(
  (script) => script.location === "head"
);
const bodyStartScripts = analyticsScripts.filter(
  (script) => script.location === "body_start"
);
const bodyEndScripts = analyticsScripts.filter(
  (script) => script.location === "body_end"
);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- Runtime API URL and currency for client-side JS (Cloudflare Worker env vars aren't available to Vite client bundles) -->
    <script is:inline define:vars={{ __apiBaseUrl: import.meta.env.PUBLIC_API_URL || "/api/v1", __currencySymbol: currencySymbol, __currencyCode: currencyCode }}>
      window.__API_BASE_URL__ = __apiBaseUrl;
      window.__CURRENCY_SYMBOL__ = __currencySymbol;
      window.__CURRENCY_CODE__ = __currencyCode;
    </script>

    <!-- Stale Asset Detector -->
    <script is:inline>
      (function () {
        var r = sessionStorage.getItem("_ar");
        if (r && Date.now() - parseInt(r, 10) < 30000) return;

        window.addEventListener(
          "error",
          function (e) {
            var t = e.target;
            if (!t || !t.tagName) return;
            var tag = t.tagName.toUpperCase();
            var url = t.src || t.href || "";
            if (
              (tag === "SCRIPT" || tag === "LINK") &&
              url.indexOf("/_astro/") > -1
            ) {
              console.warn("[StaleAsset] 404:", url);
              sessionStorage.setItem("_ar", Date.now().toString());
              location.reload();
            }
          },
          true
        );

        window.addEventListener("unhandledrejection", function (e) {
          if (
            e.reason &&
            e.reason.message &&
            e.reason.message.indexOf("dynamically imported") > -1 &&
            e.reason.message.indexOf("/_astro/") > -1
          ) {
            console.warn("[StaleAsset] Import failed");
            sessionStorage.setItem("_ar", Date.now().toString());
            location.reload();
          }
        });
      })();
    </script>

    <!-- Prevent browser from caching this HTML -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <link rel="icon" href={faviconUrl} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}

    {headScripts.map((script) => <Fragment set:html={script.config} />)}

    <script is:inline>
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const fbclid = urlParams.get("fbclid");
        if (fbclid) {
          const creationTime = Date.now();
          const fbcValue = `fb.1.${creationTime}.${fbclid}`;
          document.cookie = `_fbc=${fbcValue}; path=/; max-age=7776000`;
          sessionStorage.setItem("scalius_fbc", fbcValue);
        }
      } catch (e) {
        console.warn("Could not process fbclid:", e);
      }
    </script>

    <slot name="head" />
  </head>
  <body class="flex flex-col min-h-screen site-root">
    {bodyStartScripts.map((script) => <Fragment set:html={script.config} />)}

    <div class="site-wrapper grow">
      {
        !hideHeader && (
          <Header headerData={headerData} navigation={navigationData} />
        )
      }
      <main class="w-full h-full mb-3">
        <slot />
      </main>
    </div>

    {!hideFooter && <Footer footerData={footerData} />}

    <Toaster position="top-right" expand={false} richColors closeButton />

    <CommandPalette client:idle />
    <AuthModal client:idle />

    {bodyEndScripts.map((script) => <Fragment set:html={script.config} />)}
  </body>
</html>
