---
// src/pages/checkout.astro
// Payment method selection and processing page.
// Reached after completing the checkout form in /cart when multiple
// payment gateways are active.
//
// Flow:
//  1. Reads checkout data from sessionStorage (set by cart.astro)
//  2. Shows payment method selection (Stripe / SSLCommerz / COD)
//  3. Processes payment according to selected method
//  4. Redirects to /order-success on completion

import Layout from "@/layouts/Layout.astro";
import { getLayoutData, getCheckoutConfig } from "@/lib/api";

const [layoutData, checkoutConfig] = await Promise.all([
  getLayoutData(),
  getCheckoutConfig(),
]);
---

<Layout title="Payment" layoutData={layoutData}>
  <main class="container max-w-2xl mx-auto px-4 py-8">
    <!-- Back link -->
    <a
      href="/cart"
      id="backToCart"
      class="inline-flex items-center gap-1.5 text-sm text-gray-500 hover:text-gray-900 mb-6 transition-colors"
    >
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M15 19l-7-7 7-7" />
      </svg>
      Back to cart
    </a>

    <h1 class="text-2xl font-bold mb-6">Choose Payment Method</h1>

    <!-- Order summary (populated by JS) -->
    <div id="orderSummary" class="rounded-xl border border-gray-200 bg-gray-50 p-4 mb-6 hidden">
      <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">Order Summary</h2>
      <div class="space-y-1 text-sm text-gray-600" id="summaryDetails"></div>
    </div>

    <!-- Error message -->
    <div id="errorMsg" class="hidden bg-red-50 border border-red-200 text-red-700 rounded-lg px-4 py-3 text-sm mb-4"></div>

    <!-- Payment method cards -->
    <div id="paymentMethods" class="space-y-3 mb-6">
      <!-- Populated by JS -->
    </div>

    <!-- Stripe card element (shown only when Stripe selected) -->
    <div id="stripeSection" class="hidden rounded-xl border border-gray-200 bg-white p-5 mb-4">
      <h3 class="text-sm font-semibold mb-3">Card Details</h3>
      <div id="stripeCardElement" class="rounded-lg border border-gray-200 p-3 bg-gray-50"></div>
      <div id="stripeError" class="text-xs text-red-600 mt-2 hidden"></div>
    </div>

    <!-- Pay button -->
    <button
      id="payButton"
      class="w-full bg-black text-white font-bold text-base py-3.5 rounded-xl shadow-lg hover:bg-gray-900 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
      disabled
    >
      <span id="payButtonText">Select a payment method</span>
    </button>

    <p class="text-[10px] text-gray-400 text-center mt-3">
      Secure checkout â€¢ SSL Encrypted
    </p>
  </main>
</Layout>

<script define:vars={{ checkoutConfigJson: JSON.stringify(checkoutConfig) }}>
// â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const checkoutConfig = JSON.parse(checkoutConfigJson);

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let selectedMethod = null;
let stripeInstance = null;
let stripeElements = null;
let stripeCard = null;
let checkoutData = null;
let gateways = [];
let isProcessing = false;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showError(msg) {
  const el = document.getElementById("errorMsg");
  if (!el) return;
  el.textContent = msg;
  el.classList.remove("hidden");
  el.scrollIntoView({ behavior: "smooth", block: "center" });
}

function hideError() {
  const el = document.getElementById("errorMsg");
  el?.classList.add("hidden");
}

function setPayButton(text, disabled = false) {
  const btn = document.getElementById("payButton");
  const span = document.getElementById("payButtonText");
  if (btn) btn.disabled = disabled || isProcessing;
  if (span) span.textContent = text;
}

function currencyFmt(amount) {
  var sym = window.__CURRENCY_SYMBOL__ || "à§³";
  return sym + Number(amount).toFixed(0);
}

// â”€â”€ Load checkout data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function loadCheckoutData() {
  try {
    const raw = sessionStorage.getItem("scalius_checkout_data");
    const gwRaw = sessionStorage.getItem("scalius_checkout_gateways");
    if (!raw) {
      window.location.href = "/cart";
      return false;
    }
    checkoutData = JSON.parse(raw);
    gateways = gwRaw ? JSON.parse(gwRaw) : checkoutConfig.gateways;
    return true;
  } catch {
    window.location.href = "/cart";
    return false;
  }
}

// â”€â”€ Render order summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderSummary() {
  if (!checkoutData) return;
  const section = document.getElementById("orderSummary");
  const details = document.getElementById("summaryDetails");
  if (!section || !details) return;

  let cartItems = {};
  try { cartItems = JSON.parse(checkoutData.cartItems || "{}"); } catch {}
  const items = Object.values(cartItems);
  const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const shipping = parseFloat(checkoutData.shippingCharge || "0");
  const discount = parseFloat(checkoutData.discountAmount || "0");
  const total = subtotal + shipping - discount;

  details.innerHTML = `
    <div class="flex justify-between"><span>${items.length} item(s)</span><span>${currencyFmt(subtotal)}</span></div>
    <div class="flex justify-between"><span>Shipping</span><span>${currencyFmt(shipping)}</span></div>
    ${discount > 0 ? `<div class="flex justify-between text-green-600"><span>Discount</span><span>-${currencyFmt(discount)}</span></div>` : ""}
    <div class="flex justify-between font-bold text-gray-900 pt-2 border-t border-gray-200 mt-2 mb-2"><span>Total</span><span>${currencyFmt(total)}</span></div>
  `;

  if (checkoutConfig.partialPaymentEnabled && checkoutConfig.partialPaymentAmount > 0) {
    const advance = Math.min(checkoutConfig.partialPaymentAmount, total);
    const balance = total - advance;
    details.innerHTML += `
      <div class="flex justify-between font-bold text-blue-700 bg-blue-50 p-2 rounded-lg mb-1 border border-blue-100">
        <span>Advance Payment Required</span><span>${currencyFmt(advance)}</span>
      </div>
      <div class="flex justify-between text-gray-600 text-xs px-2 mb-2">
        <span>Balance Due on Delivery</span><span>${currencyFmt(balance)}</span>
      </div>
    `;
  }

  details.innerHTML += `
    <div class="text-[10px] text-gray-500 mt-2 border-t border-gray-200 pt-2">To: ${checkoutData.customerName} â€¢ ${checkoutData.shippingAddress || ""}</div>
  `;

  section.classList.remove("hidden");
}

// â”€â”€ Render payment method cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const GATEWAY_META = {
  stripe: { 
    label: "International Payment (Card)", 
    icon: `<svg class="w-6 h-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </svg>`, 
    desc: "Visa, Mastercard, American Express" 
  },
  sslcommerz: { 
    label: "Bangladeshi Payment (BDT)", 
    icon: `<svg class="w-6 h-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>`, 
    desc: "bKash, Nagad, Rocket, Local Cards, Net Banking" 
  },
  cod: { 
    label: "Cash on Delivery", 
    icon: `<svg class="w-6 h-6 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>`, 
    desc: "Pay when your order arrives" 
  },
};

function renderGateways() {
  const container = document.getElementById("paymentMethods");
  if (!container) return;
  container.innerHTML = "";

  for (const gw of gateways) {
    // If partial block is active, skip COD as a standalone option since online pay is mandatory
    if (checkoutConfig.partialPaymentEnabled && gw.id === "cod") continue;

    const meta = GATEWAY_META[gw.id] || { label: gw.name, icon: "ðŸ’³", desc: "" };
    
    // Adjust label if partial payment is required
    let label = meta.label;
    if (checkoutConfig.partialPaymentEnabled && (gw.id === "stripe" || gw.id === "sslcommerz")) {
      label = `Pay Advance via ${gw.name === "Online Payment" ? "Online" : "Card"}`;
    }
    const card = document.createElement("div");
    card.className = "payment-method-card cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 transition-all hover:border-gray-400 flex items-center gap-4";
    card.dataset.method = gw.id;
    card.innerHTML = `
      <div class="flex items-center justify-center w-10 h-10 rounded-full bg-slate-50 border border-slate-100 shrink-0">
        ${meta.icon}
      </div>
      <div class="flex-1">
        <p class="font-semibold text-sm text-gray-900">${label}</p>
        <p class="text-[11px] text-gray-500 leading-tight mt-0.5">${meta.desc}</p>
        ${gw.id === "sslcommerz" && gw.sandbox ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded font-medium">Sandbox</span>' : ""}
      </div>
      <div class="method-check w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center shrink-0">
        <div class="check-dot w-2.5 h-2.5 rounded-full bg-black hidden"></div>
      </div>
    `;
    card.addEventListener("click", () => selectMethod(gw.id, gw));
    container.appendChild(card);
  }
}

function selectMethod(methodId, gw) {
  selectedMethod = methodId;
  // Update card styles
  document.querySelectorAll(".payment-method-card").forEach((card) => {
    const isSelected = card.dataset.method === methodId;
    card.classList.toggle("border-black", isSelected);
    card.classList.toggle("border-gray-200", !isSelected);
    card.querySelector(".check-dot")?.classList.toggle("hidden", !isSelected);
  });

  // Show/hide Stripe section
  const stripeSection = document.getElementById("stripeSection");
  if (methodId === "stripe") {
    stripeSection?.classList.remove("hidden");
    initStripe(gw.publishableKey);
    setPayButton("Pay with Card", false);
  } else {
    stripeSection?.classList.add("hidden");
    if (methodId === "cod") setPayButton("Place Order â€” Pay on Delivery", false);
    else if (methodId === "sslcommerz") setPayButton("Continue to Payment â†’", false);
  }
}

// â”€â”€ Stripe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function initStripe(publishableKey) {
  if (stripeCard || !publishableKey) return;
  try {
    // Dynamically load Stripe.js
    if (!window.Stripe) {
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://js.stripe.com/v3/";
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }
    stripeInstance = window.Stripe(publishableKey);
    stripeElements = stripeInstance.elements();
    stripeCard = stripeElements.create("card", {
      style: {
        base: { fontSize: "15px", color: "#111", fontFamily: "sans-serif" },
        invalid: { color: "#e53e3e" },
      },
    });
    stripeCard.mount("#stripeCardElement");
    stripeCard.on("change", (event) => {
      const errEl = document.getElementById("stripeError");
      if (event.error) {
        if (errEl) { errEl.textContent = event.error.message; errEl.classList.remove("hidden"); }
      } else {
        errEl?.classList.add("hidden");
      }
    });
  } catch (err) {
    showError("Failed to load payment form. Please refresh and try again.");
  }
}

// â”€â”€ Create order via server-side proxy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function createOrder(paymentMethod) {
  let cartItems = {};
  try { cartItems = JSON.parse(checkoutData.cartItems || "{}"); } catch {}

  const items = Object.values(cartItems).map((item) => ({
    productId: item.id,
    variantId: item.variantId && item.variantId !== "default" ? item.variantId : null,
    quantity: item.quantity,
    price: item.price,
  }));

  const payload = {
    customerName: checkoutData.customerName,
    customerPhone: checkoutData.customerPhone,
    customerEmail: checkoutData.customerEmail || null,
    shippingAddress: checkoutData.shippingAddress,
    city: checkoutData.city,
    zone: checkoutData.zone,
    area: checkoutData.area || null,
    cityName: checkoutData.cityName || undefined,
    zoneName: checkoutData.zoneName || undefined,
    areaName: checkoutData.areaName || undefined,
    notes: checkoutData.notes || null,
    items,
    shippingCharge: parseFloat(checkoutData.shippingCharge || "0"),
    discountAmount: parseFloat(checkoutData.discountAmount || "0") || null,
    discountCode: checkoutData.discountCodeHidden || undefined,
    paymentMethod,
  };

  const res = await fetch("/api/checkout/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    // Handle nested error objects from backend
    const errMsg = typeof err.error === 'string' ? err.error : err.error?.message || `Order creation failed (${res.status})`;
    throw new Error(errMsg);
  }

  const data = await res.json();
  // Backend returns { success: true, data: { id, paymentMethod, totalAmount } }
  return data.data?.id || data.orderId || data.id || data.order?.id;
}

// â”€â”€ Process payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function clearCheckoutAndCart() {
  sessionStorage.removeItem("scalius_checkout_data");
  sessionStorage.removeItem("scalius_checkout_gateways");
  // Also clear the cart from localStorage
  try { localStorage.removeItem("scalius_cart"); } catch {}
}

async function processPayment() {
  if (!selectedMethod || isProcessing) return;
  isProcessing = true;
  hideError();
  setPayButton("Processing...", true);

  try {
    if (selectedMethod === "cod") {
      const orderId = await createOrder("cod");
      if (!orderId) throw new Error("Order creation failed");
      clearCheckoutAndCart();
      window.location.href = `/order-success?orderId=${orderId}`;
      return;
    }

    if (selectedMethod === "stripe") {
      if (!stripeCard || !stripeInstance) {
        throw new Error("Payment form not ready. Please wait a moment.");
      }
      const orderId = await createOrder("stripe");
      if (!orderId) throw new Error("Order creation failed");

      // Backend computes amount from DB order â€” only send orderId
      const intentPayload = { 
        orderId, 
        paymentType: checkoutConfig.partialPaymentEnabled ? "deposit" : "full",
        ...(checkoutConfig.partialPaymentEnabled && { depositAmount: checkoutConfig.partialPaymentAmount })
      };
      
      const intentRes = await fetch("/api/checkout/stripe-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(intentPayload),
      });

      if (!intentRes.ok) {
        const e = await intentRes.json().catch(() => ({}));
        throw new Error(e.error || "Payment initialization failed");
      }

      const intentData = await intentRes.json();
      const clientSecret = intentData.clientSecret;
      if (!clientSecret) throw new Error("No client secret received from payment gateway");

      const { error, paymentIntent } = await stripeInstance.confirmCardPayment(clientSecret, {
        payment_method: { card: stripeCard },
      });

      if (error) throw new Error(error.message || "Card payment failed");

      if (paymentIntent.status === "succeeded" || paymentIntent.status === "requires_capture") {
        clearCheckoutAndCart();
        window.location.href = `/order-success?orderId=${orderId}&payment=stripe`;
        return;
      }

      throw new Error("Payment was not completed");
    }

    if (selectedMethod === "sslcommerz") {
      const orderId = await createOrder("sslcommerz");
      if (!orderId) throw new Error("Order creation failed");

      // Backend reads everything from DB order â€” only send orderId
      const sessionPayload = {
        orderId,
        currency: window.__CURRENCY_CODE__ || "BDT",
        paymentType: checkoutConfig.partialPaymentEnabled ? "deposit" : "full",
        ...(checkoutConfig.partialPaymentEnabled && { depositAmount: checkoutConfig.partialPaymentAmount })
      };

      const sessionRes = await fetch("/api/checkout/sslcommerz-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sessionPayload),
      });

      if (!sessionRes.ok) {
        const e = await sessionRes.json().catch(() => ({}));
        throw new Error(e.error || "Payment gateway initialization failed");
      }

      const sessionData = await sessionRes.json();
      const gatewayUrl = sessionData.gatewayUrl;
      if (!gatewayUrl) throw new Error("No gateway URL received");

      clearCheckoutAndCart();
      window.location.href = gatewayUrl;
    }

  } catch (err) {
    showError(err.message || "An error occurred. Please try again.");
    setPayButton(selectedMethod === "cod" ? "Place Order" : selectedMethod === "stripe" ? "Pay with Card" : "Continue to Payment â†’", false);
  } finally {
    isProcessing = false;
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener("DOMContentLoaded", () => {
  if (!loadCheckoutData()) return;
  renderSummary();
  renderGateways();

  const payBtn = document.getElementById("payButton");
  payBtn?.addEventListener("click", processPayment);
});
</script>
