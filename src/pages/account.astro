---
// src/pages/account.astro
// Customer dashboard — order history, profile info, and quick actions.
// Protected: redirects to /cart if not logged in.

import Layout from "@/layouts/Layout.astro";
import { getLayoutData } from "@/lib/api";

const layoutData = await getLayoutData();
---

<Layout title="My Account" layoutData={layoutData}>
  <main class="container max-w-4xl mx-auto px-4 py-8">
    <!-- Loading state (shown while checking auth) -->
    <div id="loadingState" class="flex items-center justify-center min-h-[400px]">
      <div class="text-center">
        <div class="inline-block w-8 h-8 border-3 border-gray-200 border-t-black rounded-full animate-spin mb-4"></div>
        <p class="text-sm text-gray-500">Loading your account...</p>
      </div>
    </div>

    <!-- Unauthenticated state -->
    <div id="unauthState" class="hidden">
      <div class="max-w-md mx-auto text-center py-16">
        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gray-100 flex items-center justify-center">
          <svg class="h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <h1 class="text-2xl font-bold mb-2">Sign in to view your account</h1>
        <p class="text-gray-500 mb-6">View your orders, manage your profile, and more.</p>
        <button type="button" onclick="window.dispatchEvent(new CustomEvent('open-auth-modal'))" class="inline-flex items-center gap-2 px-6 py-3 bg-black text-white rounded-xl font-medium hover:bg-gray-900 transition-colors shadow-sm">
          Sign In or Create Account
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Authenticated state -->
    <div id="authState" class="hidden max-w-5xl mx-auto">
      
      <!-- Top header / Breadcrumb area (optional) -->
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 tracking-tight">Account Overview</h1>
        <a href="/" class="text-sm font-medium text-gray-500 hover:text-black transition-colors flex items-center gap-1.5">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          Back to Shop
        </a>
      </div>

      <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
        <!-- Sidebar: Profile & Delivery -->
        <div class="w-full lg:w-1/3 space-y-6">
          
          <!-- Identity Card -->
          <div class="bg-gray-50 rounded-2xl p-6 sm:p-8">
            <div class="flex items-start justify-between mb-6">
              <div class="h-14 w-14 bg-black text-white rounded-full flex items-center justify-center text-xl font-bold shadow-sm" id="profileAvatar">
                ?
              </div>
              <button id="logoutBtn" class="text-xs font-semibold text-gray-400 hover:text-red-600 transition-colors uppercase tracking-wider">
                Sign Out
              </button>
            </div>
            <h2 class="text-xl font-bold text-gray-900" id="profileName">Loading...</h2>
            <p class="text-gray-500 text-sm mt-1" id="profileEmail"></p>
            <p class="text-gray-400 text-sm mt-0.5" id="profilePhone"></p>
          </div>

          <!-- Quick Stats inline -->
          <div class="grid grid-cols-2 gap-3" id="statsGrid">
            <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm text-center">
              <p class="text-2xl font-bold text-gray-900" id="statTotalOrders">–</p>
              <p class="text-[11px] font-semibold text-gray-400 uppercase tracking-wide mt-1">Orders</p>
            </div>
            <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm text-center">
              <p class="text-2xl font-bold text-gray-900" id="statTotalSpent">–</p>
              <p class="text-[11px] font-semibold text-gray-400 uppercase tracking-wide mt-1">Total Spent</p>
            </div>
          </div>

          <!-- Settings / Address Card -->
          <div class="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden">
            <button id="profileToggle" class="w-full p-5 flex items-center justify-between text-left hover:bg-gray-50/50 transition-colors">
              <span class="text-sm font-bold text-gray-900 uppercase tracking-wider">Delivery Details</span>
              <span class="text-xs font-medium text-blue-600">Edit</span>
            </button>
            <div id="profileForm" class="hidden p-5 pt-0 border-t border-gray-50 mt-2 space-y-4">
              <div>
                <label class="block text-[11px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Full Name</label>
                <input id="fieldName" type="text" class="w-full bg-gray-50 border-transparent focus:bg-white focus:border-gray-300 focus:ring-0 rounded-lg text-sm px-3 py-2.5 transition-all outline-none" />
              </div>
              <div>
                <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1.5">Phone (Read-only)</label>
                <input id="fieldPhone" type="tel" disabled class="w-full bg-gray-50 border-transparent text-gray-400 rounded-lg text-sm px-3 py-2.5 cursor-not-allowed outline-none" />
              </div>
              <div>
                <label class="block text-[11px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Address</label>
                <input id="fieldAddress" type="text" class="w-full bg-gray-50 border-transparent focus:bg-white focus:border-gray-300 focus:ring-0 rounded-lg text-sm px-3 py-2.5 transition-all outline-none" placeholder="Apt, Street" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-[11px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5">City</label>
                  <select id="fieldCity" class="w-full bg-gray-50 border-transparent focus:bg-white focus:border-gray-300 focus:ring-0 rounded-lg text-sm px-3 py-2.5 transition-all outline-none">
                    <option value="">City</option>
                  </select>
                </div>
                <div>
                  <label class="block text-[11px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Zone</label>
                  <select id="fieldZone" disabled class="w-full bg-gray-50 border-transparent focus:bg-white focus:border-gray-300 focus:ring-0 rounded-lg text-sm px-3 py-2.5 transition-all outline-none disabled:opacity-50">
                    <option value="">Zone</option>
                  </select>
                </div>
              </div>
              <button id="saveProfileBtn" class="w-full mt-2 py-2.5 bg-black text-white text-sm font-bold rounded-lg hover:bg-gray-900 transition-colors shadow-sm">
                Save Address
              </button>
              <p id="profileSaveStatus" class="text-xs text-center hidden mt-2"></p>
            </div>
          </div>
        </div>

        <!-- Main Content: Orders -->
        <div class="w-full lg:w-2/3">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-900">Order History</h2>
            <span class="text-xs font-semibold text-gray-500 tracking-wider uppercase bg-gray-100 px-3 py-1 rounded-full" id="orderCount"></span>
          </div>

          <!-- Empty state -->
          <div id="emptyOrders" class="hidden p-12 text-center bg-gray-50 rounded-2xl border border-dashed border-gray-200">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-white shadow-sm flex items-center justify-center">
              <svg class="h-6 w-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-1">No orders yet</h3>
            <p class="text-sm text-gray-500 mb-6">When you buy something, your receipt will be here.</p>
            <a href="/" class="inline-flex items-center px-5 py-2.5 bg-black text-white text-sm font-semibold rounded-lg hover:bg-gray-900 transition-colors">Start Shopping</a>
          </div>

          <!-- Orders list -->
          <div id="ordersList" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { getCustomerSession, getCustomerOrders, logoutCustomer, updateCustomerProfile, type CustomerOrder } from "@/lib/api/customer-auth";
  import { getCities, getZones } from "@/lib/api/shipping";

  const STATUS_COLORS: Record<string, { bg: string; text: string }> = {
    pending: { bg: "bg-amber-50", text: "text-amber-700" },
    confirmed: { bg: "bg-blue-50", text: "text-blue-700" },
    processing: { bg: "bg-indigo-50", text: "text-indigo-700" },
    shipped: { bg: "bg-purple-50", text: "text-purple-700" },
    delivered: { bg: "bg-green-50", text: "text-green-700" },
    completed: { bg: "bg-green-50", text: "text-green-700" },
    cancelled: { bg: "bg-red-50", text: "text-red-700" },
    refunded: { bg: "bg-gray-100", text: "text-gray-600" },
  };

  const PAYMENT_LABELS: Record<string, string> = {
    cod: "Cash on Delivery",
    stripe: "Card Payment",
    sslcommerz: "Online Payment",
  };

  function formatDate(iso: string | null): string {
    if (!iso) return "—";
    const d = new Date(iso);
    return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
  }

  function formatCurrency(amount: number): string {
    const sym = (window as any).__CURRENCY_SYMBOL__ || "৳";
    return sym + amount.toFixed(0);
  }

  function renderOrder(order: CustomerOrder): string {
    const statusStyle = STATUS_COLORS[order.status] || STATUS_COLORS.pending;
    const itemCount = order.items.reduce((s, i) => s + i.quantity, 0);

    // Item details layout (shown when expanded)
    const itemDetails = order.items.map((item) =>
      `<div class="flex items-start gap-4 py-3">
        <img src="${item.productImage || "/placeholder.jpg"}" alt="" class="w-12 h-12 rounded-md object-cover border border-gray-100 shrink-0 bg-white" loading="lazy" />
        <div class="flex-1 min-w-0">
          <p class="text-sm font-semibold text-gray-900 truncate">${item.productName || "Product"}</p>
          ${(item.variantSize || item.variantColor)
            ? `<p class="text-[11px] font-medium text-gray-500 mt-0.5">${[item.variantSize && `Size: ${item.variantSize}`, item.variantColor && `Color: ${item.variantColor}`].filter(Boolean).join(" • ")}</p>`
            : ""}
        </div>
        <div class="text-right shrink-0">
          <p class="text-sm font-bold text-gray-900">${formatCurrency(item.quantity * item.price)}</p>
          <p class="text-[11px] text-gray-500 mt-0.5">${item.quantity} × ${formatCurrency(item.price)}</p>
        </div>
      </div>`
    ).join("");

    return `
      <div class="order-card bg-white border border-gray-100 rounded-2xl p-5 shadow-sm hover:shadow-md transition-shadow">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
           <div>
             <div class="flex items-center gap-3">
               <span class="text-lg font-bold text-gray-900">#${order.id}</span>
               <span class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider ${statusStyle.bg} ${statusStyle.text}">${order.status}</span>
             </div>
             <p class="text-sm text-gray-500 mt-1">${formatDate(order.createdAt)} • ${itemCount} item${itemCount !== 1 ? "s" : ""}</p>
           </div>
           <div class="text-left sm:text-right flex flex-row sm:flex-col items-center sm:items-end justify-between sm:justify-start">
             <p class="text-xl font-bold text-gray-900">${formatCurrency(order.totalAmount)}</p>
             <button class="text-[11px] tracking-wide uppercase font-bold text-blue-600 hover:text-blue-800 transition-colors mt-1" onclick="this.closest('.order-card').querySelector('.order-details').classList.toggle('hidden')">View Details</button>
           </div>
        </div>
        <div class="order-details hidden border-t border-gray-100 pt-2 mt-4">
           <div class="divide-y divide-gray-50">
             ${itemDetails}
           </div>
           
           <div class="mt-3 pt-3 border-t border-gray-100 flex flex-col items-end gap-1 text-sm bg-gray-50/50 p-3 rounded-lg">
             ${order.shippingCharge > 0 ? `<div class="w-full sm:w-64 flex justify-between text-gray-500 text-xs"><span>Delivery Fee</span><span>${formatCurrency(order.shippingCharge)}</span></div>` : ""}
             ${(order.discountAmount ?? 0) > 0 ? `<div class="w-full sm:w-64 flex justify-between text-green-600 text-xs"><span>Discount</span><span>-${formatCurrency(order.discountAmount!)}</span></div>` : ""}
             <div class="w-full sm:w-64 flex justify-between font-bold text-gray-900 mt-1 pt-1 border-t border-gray-200"><span>Order Total</span><span>${formatCurrency(order.totalAmount)}</span></div>
             ${order.shippingAddress ? `<div class="w-full text-left mt-2 text-[11px] text-gray-500"><span class="font-semibold text-gray-600">Shipped to:</span> ${order.shippingAddress}${order.cityName ? `, ${order.cityName}` : ""}${order.zoneName ? `, ${order.zoneName}` : ""}</div>` : ""}
           </div>
        </div>
      </div>
    `;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const loadingState = document.getElementById("loadingState")!;
    const unauthState = document.getElementById("unauthState")!;
    const authState = document.getElementById("authState")!;

    // Check session
    const session = await getCustomerSession();

    if (!session.authenticated || !session.customer) {
      loadingState.classList.add("hidden");
      unauthState.classList.remove("hidden");
      return;
    }

    // Fill profile info
    const customer = session.customer;
    document.getElementById("profileAvatar")!.textContent = customer.name.charAt(0).toUpperCase();
    document.getElementById("profileName")!.textContent = customer.name;
    document.getElementById("profileEmail")!.textContent = customer.email;
    if (customer.phone) {
      document.getElementById("profilePhone")!.textContent = customer.phone;
    }

    // Fetch orders
    const result = await getCustomerOrders();

    // Render stats
    const orders = result.orders || [];
    const totalSpent = orders.reduce((s, o) => s + o.totalAmount, 0);
    const completed = orders.filter((o) => o.status === "delivered" || o.status === "completed").length;
    const pending = orders.filter((o) => o.status === "pending" || o.status === "confirmed" || o.status === "processing").length;

    document.getElementById("statTotalOrders")!.textContent = String(orders.length);
    document.getElementById("statTotalSpent")!.textContent = formatCurrency(totalSpent);
    
    const statCompleted = document.getElementById("statCompleted");
    if (statCompleted) statCompleted.textContent = String(completed);
    
    const statPending = document.getElementById("statPending");
    if (statPending) statPending.textContent = String(pending);
    document.getElementById("orderCount")!.textContent = `${orders.length} order${orders.length !== 1 ? "s" : ""}`;

    // Render orders
    const ordersList = document.getElementById("ordersList")!;
    const emptyOrders = document.getElementById("emptyOrders")!;

    if (orders.length === 0) {
      emptyOrders.classList.remove("hidden");
    } else {
      ordersList.innerHTML = orders.map(renderOrder).join("");
    }

    // Show auth state
    loadingState.classList.add("hidden");
    authState.classList.remove("hidden");

    // Pre-fill profile fields: prefer customer DB profile, fallback to latest order
    let fName = document.getElementById("fieldName") as HTMLInputElement;
    let fPhone = document.getElementById("fieldPhone") as HTMLInputElement;
    let fAddress = document.getElementById("fieldAddress") as HTMLInputElement;
    let fCity = document.getElementById("fieldCity") as unknown as HTMLSelectElement;
    let fZone = document.getElementById("fieldZone") as unknown as HTMLSelectElement;

    const dbCustomer = result.customer && Object.keys(result.customer).length > 0 ? result.customer : null;
    const latestOrder = orders.length > 0 ? orders[0] : null;

    if (fName) fName.value = dbCustomer?.name || customer.name || "";
    if (fPhone) fPhone.value = customer.phone || ""; // Phone MUST be from session
    if (fAddress) fAddress.value = dbCustomer?.address || latestOrder?.shippingAddress || "";

    // Load locations and handle City/Zone dependent dropdowns
    if (fCity && fZone) {
      const cities = await getCities() || [];
      
      // Populate cities
      fCity.innerHTML = '<option value="">Select City</option>';
      cities.forEach(city => {
        const option = document.createElement("option");
        option.value = city.id; // API requires external names mostly, let's store name as value if needed, or rely on id.
        option.textContent = city.name;
        // if value comes down as name we need to match it, LocationData has {id, name}
        // Actually ProfileUpdateData uses 'cityName'. We should set value to name for the form submit.
        option.value = city.name; 
        option.dataset.id = city.id; 
        fCity.appendChild(option);
      });

      const initialCityName = dbCustomer?.cityName || dbCustomer?.city || latestOrder?.cityName || "";
      let initialCityId = "";

      if (initialCityName) {
        // Find city option by name and select it
        const cityOption = Array.from(fCity.options).find(opt => opt.value === initialCityName);
        if (cityOption) {
          fCity.value = cityOption.value;
          initialCityId = cityOption.dataset.id || "";
        }
      }

      // Handle city change
      fCity.addEventListener("change", async (e) => {
        const target = e.target as HTMLSelectElement;
        const selectedOption = target.options[target.selectedIndex];
        const cityId = selectedOption?.dataset?.id;
        
        fZone.innerHTML = '<option value="">Select Zone</option>';
        fZone.disabled = true;

        if (cityId) {
          const zones = await getZones(cityId) || [];
          zones.forEach(zone => {
            const option = document.createElement("option");
            option.value = zone.name;
            option.textContent = zone.name;
            fZone.appendChild(option);
          });
          fZone.disabled = false;
        }
      });

      // Populate zones initially if a city is already selected
      if (initialCityId) {
        const zones = await getZones(initialCityId) || [];
        fZone.innerHTML = '<option value="">Select Zone</option>';
        zones.forEach(zone => {
          const option = document.createElement("option");
          option.value = zone.name;
          option.textContent = zone.name;
          fZone.appendChild(option);
        });
        fZone.disabled = false;
        
        const initialZoneName = dbCustomer?.zoneName || dbCustomer?.zone || latestOrder?.zoneName || "";
        if (initialZoneName) {
          const zoneOption = Array.from(fZone.options).find(opt => opt.value === initialZoneName);
          if (zoneOption) fZone.value = zoneOption.value;
        }
      }
    }

    // Profile toggle
    const profileToggle = document.getElementById("profileToggle");
    const profileForm = document.getElementById("profileForm");
    const profileChevron = document.getElementById("profileChevron");
    profileToggle?.addEventListener("click", () => {
      profileForm?.classList.toggle("hidden");
      profileChevron?.classList.toggle("rotate-180");
    });

    // Save profile handler
    document.getElementById("saveProfileBtn")?.addEventListener("click", async () => {
      const btn = document.getElementById("saveProfileBtn") as HTMLButtonElement;
      const status = document.getElementById("profileSaveStatus")!;
      const originalText = btn.textContent;

      const fName = (document.getElementById("fieldName") as HTMLInputElement).value;
      const fAddress = (document.getElementById("fieldAddress") as HTMLInputElement).value;
      const fCity = (document.getElementById("fieldCity") as unknown as HTMLSelectElement).value;
      const fZone = (document.getElementById("fieldZone") as unknown as HTMLSelectElement).value;

      btn.disabled = true;
      btn.textContent = "Saving...";
      status.classList.add("hidden");
      status.className = "text-sm";

      const res = await updateCustomerProfile({
        name: fName,
        address: fAddress,
        cityName: fCity,
        zoneName: fZone,
      });

      btn.disabled = false;
      btn.textContent = originalText;

      if (res.success) {
        status.textContent = "Profile updated successfully!";
        status.classList.add("text-green-600");
        status.classList.remove("hidden");
        // Update name in header if changed
        if (fName) {
          document.getElementById("profileName")!.textContent = fName;
          document.getElementById("profileAvatar")!.textContent = fName.charAt(0).toUpperCase();
        }
        setTimeout(() => status.classList.add("hidden"), 3000);
      } else {
        status.textContent = res.error || "Failed to update profile";
        status.classList.add("text-red-600");
        status.classList.remove("hidden");
      }
    });

    // Logout handler
    document.getElementById("logoutBtn")!.addEventListener("click", async () => {
      // Clear cs_auth for BOTH host-only and the root domain (.wrygo.com)
      // to cover however the cookie was originally set.
      const rootDomain = window.location.hostname.split(".").slice(-2).join(".");
      document.cookie = "cs_auth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      document.cookie = `cs_auth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.${rootDomain};`;

      await logoutCustomer();
      window.location.href = "/";
    });

    // Login handler (from modal)
    window.addEventListener("customer-login", () => {
      window.location.reload();
    });
  });

  // Init on page load
  document.addEventListener("astro:page-load", async () => {
    // Re-run the DOMContentLoaded logic for Astro page loads
    await (document.querySelector("script") as HTMLScriptElement).dispatchEvent(new Event("DOMContentLoaded"));
  });
</script>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  .border-3 {
    border-width: 3px;
  }
  .order-card {
    transition: background-color 0.15s ease;
  }
</style>
