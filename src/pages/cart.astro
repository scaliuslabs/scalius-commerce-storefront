---
// src/pages/cart.astro
import Layout from "@/layouts/Layout.astro";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import LocationSelector from "@/components/LocationSelector";
import ShippingLocationSelector from "@/components/ShippingLocationSelector";
import { getCities, processOrder } from "@/lib/cart/server";
import {
  getShippingMethods,
  getLayoutData,
  type ShippingMethod,
  getActiveCheckoutLanguage,
  type CheckoutLanguageData,
  getCheckoutConfig,
  isCodOnly,
} from "@/lib/api";

// Parallel fetch: layout + cities + shipping methods + checkout language + checkout config
const [
  layoutData,
  cities,
  shippingMethodsResponse,
  checkoutLanguageResponse,
  checkoutConfig,
] = await Promise.all([
  getLayoutData(),
  getCities(),
  getShippingMethods(),
  getActiveCheckoutLanguage(),
  getCheckoutConfig(),
]);
const shippingMethods: ShippingMethod[] = shippingMethodsResponse || [];
const codOnly = isCodOnly(checkoutConfig);
const lang: CheckoutLanguageData = checkoutLanguageResponse || {
  id: "fallback",
  name: "English (Fallback)",
  code: "en",
  languageData: {
    pageTitle: "Cart & Checkout",
    checkoutSectionTitle: "Checkout Information",
    cartSectionTitle: "Shopping Cart",
    customerNameLabel: "Full Name",
    customerNamePlaceholder: "Enter your full name",
    customerPhoneLabel: "Phone Number",
    customerPhonePlaceholder: "01XXXXXXXXX",
    customerPhoneHelp: "Example: 01712345678",
    customerEmailLabel: "Email (Optional)",
    customerEmailPlaceholder: "Enter your email address",
    shippingAddressLabel: "Delivery Address",
    shippingAddressPlaceholder: "Enter your full delivery address",
    cityLabel: "City",
    zoneLabel: "Zone",
    areaLabel: "Area (Optional)",
    shippingMethodLabel: "Choose Delivery Option",
    orderNotesLabel: "Order Notes (Optional)",
    orderNotesPlaceholder: "Any special instructions for your order?",
    continueShoppingText: "Continue Shopping",
    subtotalText: "Subtotal",
    shippingText: "Shipping",
    discountText: "Discount",
    totalText: "Total",
    discountCodePlaceholder: "Discount code",
    applyDiscountText: "Apply",
    removeDiscountText: "Remove",
    placeOrderText: "Place Order",
    processingText: "Processing...",
    emptyCartText: "Your cart is empty",
    termsText:
      "By placing this order, you agree to our Terms of Service and Privacy Policy",
    processingOrderTitle: "Processing Your Order",
    processingOrderMessage: "Please wait while we process your order.",
    requiredFieldIndicator: "*",
  },
  fieldVisibility: {
    showEmailField: true,
    showOrderNotesField: true,
    showAreaField: true,
  },
  isActive: true,
  isDefault: true,
};

// Initialize error message and success state
let errorMessage = "";
let successOrderId = "";
let isProcessing = false;

// Handle form submission — only for COD-only flow.
// When multiple gateways are active, the form is intercepted client-side
// and the user is redirected to /checkout for payment selection.
if (Astro.request.method === "POST" && codOnly) {
  try {
    isProcessing = true;
    const formData = await Astro.request.formData();

    // Check if cart is empty
    const cartItems = formData.get("cartItems") as string;
    if (!cartItems || cartItems === "{}" || cartItems === "[]") {
      throw new Error(
        "Your cart is empty. Please add items to your cart before placing an order."
      );
    }

    const result = await processOrder(formData);

    if (result.success && result.orderId) {
      successOrderId = result.orderId;
      return Astro.redirect(`/order-success?orderId=${result.orderId}`);
    } else {
      console.error("Order processing failed:", result.error);
      errorMessage =
        result.error?.message || "Failed to process order. Please try again.";
    }
  } catch (error) {
    console.error("Order creation failed:", error);
    errorMessage =
      error instanceof Error ? error.message : "An unexpected error occurred";
  } finally {
    isProcessing = false;
  }
}

// Determine submit button label
const submitLabel = codOnly
  ? lang.languageData.placeOrderText
  : "Proceed to Payment →";
---

<Layout title={lang.languageData.pageTitle} layoutData={layoutData}>
  <!-- Hidden checkout meta for client-side JS -->
  <div
    id="checkout-meta"
    data-cod-only={codOnly ? "true" : "false"}
    data-gateways={JSON.stringify(checkoutConfig.gateways)}
    data-guest-checkout-enabled={checkoutConfig.guestCheckoutEnabled !== false ? "true" : "false"}
    hidden
  ></div>

  <main
    class="container max-w-6xl mx-auto px-2 pt-2 pb-3 sm:px-3 sm:pt-2 sm:pb-3"
  >
    {
      errorMessage && (
        <div
          class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 sm:px-4 sm:py-3 rounded mb-2 sm:mb-2.5 relative text-xs sm:text-sm"
          role="alert"
        >
          <strong class="font-bold">Error: </strong>
          <span class="block sm:inline">{errorMessage}</span>
        </div>
      )
    }

    {
      successOrderId && (
        <div
          class="bg-green-100 border border-green-400 text-green-700 px-3 py-2 sm:px-4 sm:py-3 rounded mb-2 sm:mb-2.5 relative text-xs sm:text-sm"
          role="alert"
        >
          <strong class="font-bold">Success! </strong>
          <span class="block sm:inline">
            Your order has been placed successfully. Order ID: {successOrderId}
          </span>
        </div>
      )
    }

    <div class="flex flex-col lg:flex-row-reverse gap-4 lg:gap-8">
      <!-- Cart Items Section - Right on Desktop -->
      <div
        class="lg:w-5/12 lg:sticky lg:self-start transition-all duration-200 order-2 lg:order-1"
        style="top: calc(var(--header-height, 64px) + 1rem);"
      >
        <div
          class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden"
        >
          <div
            class="p-3 sm:p-4 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between"
          >
            <h2 class="text-sm sm:text-base font-bold text-gray-900">
              {lang.languageData.cartSectionTitle}
            </h2>
            <a
              href="/"
              class="text-xs font-medium text-gray-500 hover:text-black transition-colors"
            >
              {lang.languageData.continueShoppingText}
            </a>
          </div>

          <div class="divide-y divide-gray-50 p-3 sm:p-4 block" id="cartItems">
            <!-- Cart items will be rendered here by JavaScript -->
          </div>

          <div
            class="bg-gray-50/50 p-3 sm:p-4 space-y-2 border-t border-gray-100"
          >
            <div class="flex justify-between text-xs sm:text-sm text-gray-600">
              <span>{lang.languageData.subtotalText}</span>
              <span id="subtotal" class="font-medium text-gray-900">৳0</span>
            </div>
            <div class="flex justify-between text-xs sm:text-sm text-gray-600">
              <span>{lang.languageData.shippingText}</span>
              <span id="shippingCost" class="font-medium text-gray-900">৳0</span
              >
            </div>
            <div
              class="flex justify-between text-xs sm:text-sm text-green-600"
              id="discountRow"
            >
              <span class="flex items-center gap-1"
                >{lang.languageData.discountText}
                <span
                  id="appliedDiscountCode"
                  class="font-mono text-xs bg-green-100 px-1 rounded"
                ></span></span
              >
              <span id="discountAmount" class="font-bold">-৳0</span>
            </div>

            <div class="pt-2 border-t border-gray-200 mt-2">
              <div class="flex justify-between items-baseline">
                <span class="text-sm font-bold text-gray-900"
                  >{lang.languageData.totalText}</span
                >
                <span
                  id="total"
                  class="text-lg sm:text-xl font-extrabold text-gray-900 tracking-tight"
                  >৳0</span
                >
              </div>
            </div>

            <!-- Discount Code Form -->
            <div class="pt-3 mt-1">
              <form id="discountForm" class="relative">
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="discountCodeInput"
                    placeholder={lang.languageData.discountCodePlaceholder}
                    class="flex-1 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-all"
                  />
                  <button
                    type="submit"
                    id="applyDiscountBtn"
                    class="px-3 py-1.5 bg-gray-900 text-white text-xs sm:text-sm font-semibold rounded-lg hover:bg-black transition-colors"
                  >
                    {lang.languageData.applyDiscountText}
                  </button>
                  <button
                    type="button"
                    id="removeDiscountBtn"
                    onclick="window.removeDiscountCode()"
                    class="px-3 py-1.5 bg-red-50 text-red-600 border border-red-100 text-xs sm:text-sm font-semibold rounded-lg hover:bg-red-100 transition-colors"
                    style="display: none;"
                  >
                    {lang.languageData.removeDiscountText}
                  </button>
                </div>
                <div
                  id="discountMessage"
                  class="absolute -bottom-5 left-0 text-[10px] sm:text-xs font-medium text-red-600 truncate max-w-full"
                  style="display: none;"
                >
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Trust badges -->
        <div class="mt-4 text-center">
          <p class="text-[10px] text-gray-400">
            Secure Checkout • SSL Encrypted
          </p>
        </div>
      </div>

      <!-- Checkout Form Section - Left on Desktop -->
      <div class="lg:w-7/12 order-1 lg:order-2">

        <!-- Optional customer login trigger -->
        <div class="mb-3">
          <button 
            type="button"
            onclick="window.dispatchEvent(new CustomEvent('open-auth-modal'))"
            class="w-full text-left rounded-lg bg-green-50 border border-green-200 px-4 py-3 text-sm text-green-800 hover:bg-green-100 transition-colors shadow-sm flex items-center justify-between group"
          >
            <span class="flex items-center gap-2">
              <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span class="font-medium">Sign in for faster checkout & order tracking</span>
            </span>
            <span class="text-green-600 font-bold group-hover:translate-x-0.5 transition-transform">→</span>
          </button>
        </div>

        <div
          class="bg-white rounded-xl border border-gray-100 shadow-sm p-3 sm:p-4 mb-3"
        >
          <h2
            class="text-base sm:text-lg font-bold text-gray-900 mb-3 flex items-center gap-2"
          >
            {lang.languageData.checkoutSectionTitle}
          </h2>

          <form method="POST" class="space-y-3" id="checkoutForm">
            <input type="hidden" name="cartItems" id="cartItemsInput" />
            <input type="hidden" name="checkoutId" id="checkoutIdInput" />
            <input
              type="hidden"
              name="discountCodeHidden"
              id="discountCodeHidden"
            />

            <div class="grid gap-3 sm:grid-cols-2">
              <div>
                <Label
                  htmlFor="customerName"
                  className="mb-1 block text-xs font-semibold text-gray-700 uppercase tracking-wide"
                >
                  {lang.languageData.customerNameLabel}
                  <span class="text-red-500 ml-0.5">*</span>
                </Label>
                <Input
                  type="text"
                  id="customerName"
                  name="customerName"
                  required
                  placeholder={lang.languageData.customerNamePlaceholder}
                  className="h-9 w-full bg-gray-50 border-gray-200 rounded-lg focus:bg-white focus:border-black focus:ring-black/5 text-sm"
                />
              </div>

              <div>
                <Label
                  htmlFor="customerPhone"
                  className="mb-1 block text-xs font-semibold text-gray-700 uppercase tracking-wide"
                >
                  {lang.languageData.customerPhoneLabel}
                  <span class="text-red-500 ml-0.5">*</span>
                </Label>
                <Input
                  type="tel"
                  id="customerPhone"
                  name="customerPhone"
                  required
                  placeholder={lang.languageData.customerPhonePlaceholder}
                  className="h-9 w-full bg-gray-50 border-gray-200 rounded-lg focus:bg-white focus:border-black focus:ring-black/5 text-sm"
                />
              </div>

              {
                lang.fieldVisibility.showEmailField && (
                  <div class="sm:col-span-2">
                    <Label
                      htmlFor="customerEmail"
                      className="mb-1 block text-xs font-semibold text-gray-700 uppercase tracking-wide"
                    >
                      {lang.languageData.customerEmailLabel}
                    </Label>
                    <Input
                      type="email"
                      id="customerEmail"
                      name="customerEmail"
                      placeholder={lang.languageData.customerEmailPlaceholder}
                      className="h-9 w-full bg-gray-50 border-gray-200 rounded-lg focus:bg-white focus:border-black focus:ring-black/5 text-sm"
                    />
                  </div>
                )
              }

              <div class="sm:col-span-2">
                <Label
                  htmlFor="shippingAddress"
                  className="mb-1 block text-xs font-semibold text-gray-700 uppercase tracking-wide"
                >
                  {lang.languageData.shippingAddressLabel}
                  <span class="text-red-500 ml-0.5">*</span>
                </Label>
                <Textarea
                  id="shippingAddress"
                  name="shippingAddress"
                  required
                  placeholder={lang.languageData.shippingAddressPlaceholder}
                  rows={2}
                  className="w-full min-h-16 resize-none bg-gray-50 border-gray-200 rounded-lg focus:bg-white focus:border-black focus:ring-black/5 px-3 py-2 text-sm"
                />
              </div>

              <div class="sm:col-span-2 border-t border-gray-100 pt-4">
                <div class="space-y-4">
                  <ShippingLocationSelector
                    client:load
                    shippingMethods={shippingMethods}
                    shippingMethodLabel={lang.languageData.shippingMethodLabel}
                  />

                  <div class="relative pt-1">
                    <LocationSelector
                      client:load
                      cities={cities}
                      cityLabel={lang.languageData.cityLabel}
                      zoneLabel={lang.languageData.zoneLabel}
                      areaLabel={lang.languageData.areaLabel}
                      showAreaField={lang.fieldVisibility.showAreaField}
                    />
                  </div>
                </div>
              </div>

              {
                lang.fieldVisibility.showOrderNotesField && (
                  <div class="sm:col-span-2">
                    <Label
                      htmlFor="notes"
                      className="mb-1.5 block text-xs font-semibold text-gray-700 uppercase tracking-wide"
                    >
                      {lang.languageData.orderNotesLabel}
                    </Label>
                    <Textarea
                      id="notes"
                      name="notes"
                      placeholder={lang.languageData.orderNotesPlaceholder}
                      rows={2}
                      className="w-full min-h-16 resize-none bg-gray-50 border-gray-200 rounded-lg focus:bg-white focus:border-black focus:ring-black/5 px-3 py-2.5 text-sm"
                    />
                  </div>
                )
              }
            </div>

            <div class="pt-4">
              <Button
                type="submit"
                className="w-full bg-black text-white font-bold text-base py-3 sm:py-3.5 rounded-xl shadow-lg hover:bg-gray-900 hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:scale-[0.99] transition-all duration-200 overflow-hidden relative"
                id="submitButton"
                disabled={isProcessing}
              >
                <span class="relative z-10" id="submitButtonText">
                  {isProcessing ? lang.languageData.processingText : submitLabel}
                </span>
              </Button>

              <p class="text-[10px] text-gray-400 text-center mt-3">
                {lang.languageData.termsText}
              </p>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
</Layout>

<!-- Loading overlay -->
<div
  id="loadingOverlay"
  style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 99999; backdrop-filter: blur(4px);"
>
  <div
    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; text-align: center; width: 280px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);"
  >
    <div
      style="margin: 0 auto 15px; width: 48px; height: 48px; border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; animation: spin 1s linear infinite;"
    >
    </div>
    <h3 style="margin: 0 0 8px; font-size: 16px; font-weight: bold;">
      {lang.languageData.processingOrderTitle}
    </h3>
    <p style="margin: 0 0 12px; font-size: 13px; color: #666;">
      {lang.languageData.processingOrderMessage}
    </p>
    <div
      style="width: 100%; height: 5px; background: #f3f3f3; border-radius: 2.5px; overflow: hidden;"
    >
      <div
        id="loadingProgressBar"
        style="width: 0%; height: 100%; background: #000; transition: width 0.5s;"
      >
      </div>
    </div>
  </div>
</div>

<script>
  import { initCartFunctionality } from "@/lib/cart/client";
  import { getCustomerSession } from "@/lib/api/customer-auth";
  import { getCities, getZones } from "@/lib/api/shipping";

  // Initialize cart functionality
  initCartFunctionality();

  // ── Customer login pre-fill ───────────────────────────────────────────────
  
  // Helper to normalize phone numbers
  const normalizePhone = (phone: string | undefined | null) => {
    if (!phone) return "";
    let p = phone.replace(/^\+?880/, "");
    if (p.startsWith("1")) p = "0" + p;
    return p;
  };

  // Helper to fill basic fields
  const fillBasicCustomerFields = (customer: any) => {
    if (customer?.name) {
      const el = document.getElementById("customerName") as HTMLInputElement;
      if (el && !el.value) el.value = customer.name;
    }
    if (customer?.phone) {
      const el = document.getElementById("customerPhone") as HTMLInputElement;
      if (el && !el.value) el.value = normalizePhone(customer.phone);
    }
    if (customer?.email) {
      const el = document.getElementById("customerEmail") as HTMLInputElement;
      if (el && !el.value) el.value = customer.email;
    }
    if (customer?.address) {
      const el = document.getElementById("shippingAddress") as HTMLTextAreaElement;
      if (el && !el.value) el.value = customer.address;
    }
  };

  // Helper to auto-select City/Zone dropdowns
  const fillLocationDropdowns = async (customer: any) => {
    try {
      if (!customer?.cityName && !customer?.city) return;

      const citySelect = document.querySelector('select[name="city"]') as unknown as HTMLSelectElement;
      const zoneSelect = document.querySelector('select[name="zone"]') as unknown as HTMLSelectElement;
      if (!citySelect || !zoneSelect) return;

      // Ensure cities are loaded (they should be rendered by LocationSelector visually, but we need the internal options mapping)
      // Since LocationSelector is a React component, we have to interact with its rendered raw HTML elements
      
      const cityId = customer.city || customer.cityName; // Either ID or Name fallback
      let foundCity = false;

      // 1. Find the city option
      for (let i = 0; i < citySelect.options.length; i++) {
        if (citySelect.options[i].text === customer.cityName || citySelect.options[i].value === cityId) {
          citySelect.selectedIndex = i;
          foundCity = true;
          break;
        }
      }

      if (foundCity) {
        // Dispatch 'change' so LocationSelector triggers its internal Zone fetch
        citySelect.dispatchEvent(new Event("change", { bubbles: true }));

        // Wait a beat for the React component to fetch the Zones
        setTimeout(() => {
          const expectedZone = customer.zoneName || customer.zone;
          for (let i = 0; i < zoneSelect.options.length; i++) {
            if (zoneSelect.options[i].text === expectedZone || zoneSelect.options[i].value === expectedZone) {
              zoneSelect.selectedIndex = i;
              zoneSelect.dispatchEvent(new Event("change", { bubbles: true }));
              break;
            }
          }
        }, 800);
      }
    } catch(err) {
      console.error("Cart autofill location err:", err);
    }
  };

  // 1. Initial page load hydration (standalone fetch)
  document.addEventListener("DOMContentLoaded", async () => {
    const isUserLoggedIn = document.cookie.split(";").some((c) => c.trim().startsWith("cs_auth=1"));
    if (isUserLoggedIn) {
      const session = await getCustomerSession();
      if (session?.authenticated && session.customer) {
        fillBasicCustomerFields(session.customer);
        await fillLocationDropdowns(session.customer);
      }
    }
  });

  // 2. Active login intercept (AuthModal)
  window.addEventListener("customer-login", (e: any) => {
    const customer = e.detail;
    fillBasicCustomerFields(customer);
    // Modal normally resolves quickly, but schedule location fill slightly later to avoid DOM races
    setTimeout(() => fillLocationDropdowns(customer), 300);
  });

  // ── Multi-gateway checkout redirect ──
  const meta = document.getElementById("checkout-meta");
  const codOnly = meta?.dataset.codOnly === "true";
  const guestCheckoutEnabled = meta?.dataset.guestCheckoutEnabled !== "false"; // default true

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("checkoutForm") as HTMLFormElement;
    const submitButton = document.getElementById("submitButton") as HTMLButtonElement;
    const loadingOverlay = document.getElementById("loadingOverlay") as HTMLElement;
    const progressBar = document.getElementById("loadingProgressBar") as HTMLElement;

    const isCartEmpty = () => {
      const input = document.getElementById("cartItemsInput") as HTMLInputElement;
      return !input?.value || input.value === "{}" || input.value === "[]";
    };

    const isUserLoggedIn = () => {
      return document.cookie.split(";").some((c) => c.trim().startsWith("cs_auth=1"));
    };

    const updateCheckoutButtonState = () => {
      if (submitButton) {
        const empty = isCartEmpty();
        submitButton.disabled = empty;
        if (empty) submitButton.classList.add("opacity-50", "cursor-not-allowed");
        else submitButton.classList.remove("opacity-50", "cursor-not-allowed");
      }
    };

    updateCheckoutButtonState();
    window.addEventListener("cart-updated", updateCheckoutButtonState);

    if (!form || !submitButton) return;

    form.addEventListener("submit", (e) => {
      // Guest Checkout Interception
      if (!guestCheckoutEnabled && !isUserLoggedIn()) {
        e.preventDefault();
        window.dispatchEvent(new CustomEvent("open-auth-modal"));
        return;
      }

      // Cart empty check
      if (isCartEmpty()) {
        e.preventDefault();
        alert("Your cart is empty. Please add items before placing an order.");
        return;
      }

      // Required fields validation
      const requiredFields = ["customerName", "customerPhone", "shippingAddress", "shippingLocation", "city", "zone"];
      const missing: string[] = [];
      for (const field of requiredFields) {
        const el = document.querySelector(`[name="${field}"]`) as HTMLInputElement | null;
        if (!el?.value?.trim()) missing.push(field);
      }
      if (missing.length > 0) {
        e.preventDefault();
        alert(`Please fill in all required fields: ${missing.join(", ")}`);
        return;
      }

      if (!codOnly) {
        // ── Multi-gateway flow: intercept and redirect to /checkout ──
        e.preventDefault();

        // Collect all form data + cart items into sessionStorage
        const formData = new FormData(form);
        const checkoutData: Record<string, string> = {};
        formData.forEach((value, key) => {
          checkoutData[key] = value as string;
        });

        // Also grab location hidden fields that may not be in formData
        const fields = ["city", "zone", "area", "shippingLocation", "cityName", "zoneName", "areaName"];
        for (const f of fields) {
          const el = document.querySelector(`[name="${f}"]`) as HTMLInputElement | null;
          if (el) checkoutData[f] = el.value;
        }

        // Capture the current shipping fee from the ShippingLocationSelector
        const shippingFee = (window as any).lastShippingEventDetail?.fee ?? 0;
        checkoutData["shippingCharge"] = String(shippingFee);

        try {
          sessionStorage.setItem("scalius_checkout_data", JSON.stringify(checkoutData));
          sessionStorage.setItem("scalius_checkout_gateways", meta?.dataset.gateways || "[]");
        } catch {
          // sessionStorage full — proceed anyway
        }

        window.location.href = "/checkout";
        return;
      }

      // ── COD-only flow: normal form POST ──
      submitButton.disabled = true;
      submitButton.textContent = "Processing...";
      if (loadingOverlay) {
        loadingOverlay.style.display = "block";
        document.body.style.overflow = "hidden";
        window.scrollTo(0, 0);
      }
      if (progressBar) {
        progressBar.style.width = "0%";
        setTimeout(() => { progressBar.style.width = "30%"; }, 300);
        setTimeout(() => { progressBar.style.width = "60%"; }, 1000);
        setTimeout(() => { progressBar.style.width = "80%"; }, 2000);
      }
    });
  });

  // ── PII capture (save phone/email in sessionStorage) ────────────────────
  function setupPiiCapture() {
    const phoneInput = document.getElementById("customerPhone") as HTMLInputElement;
    const emailInput = document.getElementById("customerEmail") as HTMLInputElement;

    const save = (key: string, value: string) => {
      if (!value?.trim()) { sessionStorage.removeItem(key); return; }
      try { sessionStorage.setItem(key, value.trim()); } catch {}
    };

    if (phoneInput) {
      phoneInput.addEventListener("change", () => save("scalius_user_phone", phoneInput.value));
      const saved = sessionStorage.getItem("scalius_user_phone");
      if (saved && !phoneInput.value) phoneInput.value = saved;
    }
    if (emailInput) {
      emailInput.addEventListener("change", () => save("scalius_user_email", emailInput.value));
      const saved = sessionStorage.getItem("scalius_user_email");
      if (saved && !emailInput.value) emailInput.value = saved;
    }
  }

  document.addEventListener("DOMContentLoaded", setupPiiCapture);
  document.addEventListener("astro:page-load", setupPiiCapture);

  // ── Abandoned checkout tracking ───────────────────────────────────────────
  function setupFormListeners() {
    const form = document.getElementById("checkoutForm") as HTMLFormElement;
    if (!form) return;
    form.addEventListener("input", () => {
      if ((window as any).handleAbandonedCheckout) (window as any).handleAbandonedCheckout();
    });
  }

  document.addEventListener("DOMContentLoaded", setupFormListeners);
  document.addEventListener("astro:page-load", setupFormListeners);
</script>

<style>
  * { scrollbar-width: thin; scrollbar-color: #e5e7eb transparent; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 3px; }
  .space-y-2 > div, .space-y-2\.5 > div { position: relative; }
  input:focus, textarea:focus, button:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @media (max-width: 640px) {
    .container { padding-left: 8px; padding-right: 8px; }
    .text-lg { font-size: 1rem; }
    .text-xl { font-size: 1.125rem; }
    .py-3 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .px-4 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .h-9 { height: 2rem; }
    .h-10 { height: 2.25rem; }
    .px-2\.5 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .py-1\.5 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .min-h-\[4\.5rem\] { min-height: 3.5rem; }
    .min-h-\[4rem\] { min-height: 3rem; }
  }
</style>
